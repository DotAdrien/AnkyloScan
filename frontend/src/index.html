<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>AnkyloScan | Dashboard üõ°Ô∏è</title>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="style/index.css">
    
    <script src="js/login.js" defer></script>
    <script src="js/me.js" defer></script>
</head>

<body class="bg-custom" x-data="app()" x-init="init()">

    <aside class="sidebar">
        <div @click="handleProfileClick()" class="nav-avatar">
            <span>A</span>
        </div>
        
        <nav class="nav-links">
            <template x-for="item in ['landing', 'about', 'work', 'contact']">
                <button @click="changePage(item)" 
                        class="nav-btn"
                        :class="currentPage === item ? 'active' : ''"
                        x-text="item === 'work' ? 'SCAN' : item">
                </button>
            </template>
        </nav>
    </aside>

    <main>
        <div x-html="pageContent" 
             class="page-transition"
             :class="loading ? 'hidden' : 'visible'">
        </div>
    </main>

    <script>
        function app() {
            return {
                currentPage: '', 
                pageContent: '',
                loading: false,
                user: { loggedIn: false, id: null, name: '', email: '', rank: '' },

                async init() {
                    // 1. On r√©cup√®re les infos du cookie tout de suite üç™
                    this.user = fetchMe();

                    // 2. D√©termine la page par d√©faut au chargement
                    // Si tu veux que l'actu charge toujours la landing :
                    await this.changePage('landing');
                    
                    // OU si tu veux qu'il reste sur le profil s'il √©tait dessus :
                    // const target = this.user.loggedIn ? 'profile' : 'landing';
                    // await this.changePage(target);
                },

                async changePage(pageName) {
                    this.loading = true;
                    this.currentPage = pageName;
                    try {
                        // Si on tente d'aller sur 'profile' sans √™tre connect√© -> redirection login üõ°Ô∏è
                        if (pageName === 'profile' && !this.user.loggedIn) {
                            return await this.changePage('login');
                        }

                        const response = await fetch(`view/${pageName}.html`);
                        if (!response.ok) throw new Error();
                        this.pageContent = await response.text();
                    } catch (err) {
                        this.pageContent = "<div class='main-content'>Erreur de chargement üò±</div>";
                    } finally {
                        this.loading = false;
                    }
                },

                handleProfileClick() {
                    if (this.user.loggedIn) {
                        this.changePage('profile');
                    } else {
                        this.changePage('login');
                    }
                },

                async submitLogin() {
                    await login.call(this);
                },

                logout() {
                    document.cookie = "session_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                    this.user = { loggedIn: false, id: null, name: '', email: '', rank: '' };
                    this.changePage('login');
                }
            }
        }
    </script>
</body>
</html>